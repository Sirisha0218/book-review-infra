variables:
- group: Terraform-Azure-Creds

stages:
- stage: Terraform
  jobs:
  - job: Terraform_Apply
    pool:
      name: 'linux-hosted-agent-pool'
    steps:
    - task: DownloadSecureFile@1
      name: download_ssh_key
      inputs:
        secureFile: 'id_rsa_azure.pub'

    - script: |
        mkdir -p terraform/modules/compute
        cp $(download_ssh_key.secureFilePath) terraform/modules/compute/id_rsa.pub
      displayName: "Place SSH public key for Terraform"

    - script: |
        echo "Terraform version check:"
        terraform -version || echo "Terraform not found!"
      displayName: "Check Terraform is installed"

    - script: |
        echo "Clearing any cached Azure CLI sessions..."
        az account clear || true
        rm -rf ~/.azure
      displayName: "Clear Azure CLI cache"

    - script: |
        export ARM_USE_AZUREAD=true
        export ARM_USE_AZURECLI_AUTH=false
        cd terraform
        terraform init -input=false
        terraform plan -input=false -var-file="envs/dev.tfvars"
        terraform apply -input=false -auto-approve -var-file="envs/dev.tfvars"
      displayName: "Terraform Init/Plan/Apply"
      env:
        ARM_CLIENT_ID: $(servicePrincipalId)
        ARM_CLIENT_SECRET: $(servicePrincipalKey)
        ARM_TENANT_ID: $(tenantId)
        ARM_SUBSCRIPTION_ID: $(subscriptionId)
